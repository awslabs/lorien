

<!DOCTYPE html>
<html class="writer-html5" lang="python3" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Tuning on AWS Batch &mdash; lorien alpha documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tuning on RPC Workers" href="tune_on_rpc.html" />
    <link rel="prev" title="Tuning on Local" href="tune_on_local.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> lorien
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Setup Lorien</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#tuning">Tuning</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="tune_on_local.html">Tuning on Local</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tuning on AWS Batch</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#steps">Steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tune_on_rpc.html">Tuning on RPC Workers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#performance-cost-model">Performance Cost Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#new-dialects">New Dialects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute to Lorien</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Python APIs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Index</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">lorien</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Tutorials</a> &raquo;</li>
        
      <li>Tuning on AWS Batch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/tune_on_aws_batch.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tuning-on-aws-batch">
<span id="tune-on-aws-batch"></span><h1>Tuning on AWS Batch<a class="headerlink" href="#tuning-on-aws-batch" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we introduce how to setup an AWS batch environment to distributely tune a huge number of workloads on AWS EC2 supported platforms step-by-step:</p>
<div class="section" id="steps">
<h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setup-aws-account-and-credential">
<h3>1. Setup AWS account and credential<a class="headerlink" href="#setup-aws-account-and-credential" title="Permalink to this headline">¶</a></h3>
<p>To use AWS batch (and other AWS services such as DynamoDB and S3 used by Lorien), you need to create an AWS account and an IAM role with 1) an access key and 2) secret access key ready in order to configure AWS credential on host as well as worker machines/instances. The purpose of configuring AWS credential is to authorize AWS client APIs (i.e., <code class="docutils literal notranslate"><span class="pre">boto3</span></code> Python package) to access AWS services on your behalf, so that Lorien can help automating everything for you.</p>
<p>After creating an AWS account, please refer to <a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html</a> to get your access key and secret access key ready. We will use them to configure Lorien in the last step.</p>
</div>
<div class="section" id="prepare-container-images">
<h3>2. Prepare Container Images<a class="headerlink" href="#prepare-container-images" title="Permalink to this headline">¶</a></h3>
<p>Since AWS batch runs every submitted jobs in a container to guarantee a unified environment, we need to specify an image ID when creating an AWS batch computation environment. Please note that Lorien docker images on Docker Hub only include the dependencies (e.g., Python packages and TVM) but not Lorien itself, so you can base on that to create a working image. You can create your own docker account and push the image (in private), or you can push your images to AWS ECR (Elastic Container Registry). To do so, you need to first authorize Docker CLI to push your images to AWS ECR. The command for authorization can be generated by AWS CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate docker login command.</span>
aws ecr get-login --no-include-email
<span class="c1"># Out: docker login –u AWS –p password https://&lt;aws_account&gt;.dkr.ecr.&lt;region&gt;&gt;.amazonaws.com</span>

<span class="c1"># Copy-paste the generated command to login.</span>
docker login –u AWS –p password https://&lt;aws_account&gt;.dkr.ecr.&lt;region&gt;&gt;.amazonaws.com

<span class="c1"># Change the tag of your image. Replace &lt;repo&gt;:&lt;tag&gt; with your local Docker repository name and tag.</span>
docker tag &lt;repo&gt;:&lt;tag&gt; &lt;aws_account&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;ecr_repo&gt;:&lt;tag&gt;

<span class="c1"># Push your image to AWS ECR.</span>
docker push &lt;aws_account&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;ecr_repo&gt;:&lt;tag&gt;
</pre></div>
</div>
<p>Note that you can use AWS ECR console to create a repository to maintain Lorien images.</p>
</div>
<div class="section" id="create-an-aws-batch-compute-environment">
<h3>3. Create an AWS batch compute environment<a class="headerlink" href="#create-an-aws-batch-compute-environment" title="Permalink to this headline">¶</a></h3>
<p>Now we can start setting AWS batch. The first step is to create a compute environment. A compute environment describes platform details of your submitted jobs. Go to <code class="samp docutils literal notranslate"><span class="pre">https://&lt;region&gt;.console.aws.amazon.com/batch</span></code>  -&gt; <code class="docutils literal notranslate"><span class="pre">Compute</span> <span class="pre">environments</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">environment</span></code> and fill out the information. In this example, we create a C5 environment as follows:</p>
<ul class="simple">
<li><p><strong>Compute environment type</strong>: <code class="docutils literal notranslate"><span class="pre">Managed</span></code>.</p></li>
<li><p><strong>Compute environment name</strong>: <code class="docutils literal notranslate"><span class="pre">lorien-c5-env</span></code>.</p></li>
<li><p><strong>Service role</strong>: <code class="docutils literal notranslate"><span class="pre">AWSBatchServiceRole</span></code>. (If this is the first environment you create, leave this box blank and AWS batch will create <code class="docutils literal notranslate"><span class="pre">AWSBatchServiceRole</span></code> IAM role for you.)</p></li>
<li><p><strong>Instance role</strong>: <code class="docutils literal notranslate"><span class="pre">ecsInstanceRole</span></code>. (If this is the first environment you create, leave this box blank and AWS batch will create <code class="docutils literal notranslate"><span class="pre">ecsInstanceRole</span></code> IAM instance profile for you.)</p></li>
<li><p><strong>EC2 key pair</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code>. (Leave it blank because we will configure AWS credential when launching a container.)</p></li>
<li><p><strong>Provisioning model</strong>: <code class="docutils literal notranslate"><span class="pre">On-Demand</span></code> (Although spot instances are much cheaper, it has a risk to be terminated by AWS any time. Since Lorien tuning jobs usually needs minutes to hours, it is recommended to use on-demand instances.)</p></li>
<li><p><strong>Allowed instance types</strong>: <code class="docutils literal notranslate"><span class="pre">c5.4xlarge</span></code> (It is not recommended to specify more then one types of instances in one computation environment, because in that case we cannot know which type of instances is being used to tune a workload. In other words, you need to create <code class="docutils literal notranslate"><span class="pre">N</span></code> environments if you need to tune worklaods on <code class="docutils literal notranslate"><span class="pre">N</span></code> types of instances.)</p></li>
<li><p><strong>Allocation strategy</strong>: <code class="docutils literal notranslate"><span class="pre">BEST_FIT</span></code>.</p></li>
<li><p><strong>Launch template</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code> (If your container image is too large, then you may encounter job starting failures when submitting jobs to AWS batch. This is because the default docker image size limit is set to 10~Gib. In this case, you could follow <code class="docutils literal notranslate"><span class="pre">scripts/aws/create_launch_template.sh</span></code> to create a launch template that modifies the docker image size limitation.)</p></li>
<li><p><strong>Launch template version</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code>.</p></li>
<li><p><strong>Minimum vCPUs</strong>: <code class="docutils literal notranslate"><span class="pre">0</span></code> (Do not specify a number larger than 0; otherwise you will have minimum cores running for all times even you do not submit any jobs.)</p></li>
<li><p><strong>Maximum vCPUs</strong>: <code class="docutils literal notranslate"><span class="pre">256</span></code> (You have to do some math. For example, <code class="docutils literal notranslate"><span class="pre">c5.4xlarge</span></code> has <code class="docutils literal notranslate"><span class="pre">16</span></code> cores, so you will have at most <code class="docutils literal notranslate"><span class="pre">256/16=16</span></code> C5s working. You can refer to <a class="reference external" href="https://aws.amazon.com/ec2/instance-types/">https://aws.amazon.com/ec2/instance-types/</a> for the number of cores on each instance.)</p></li>
<li><p><strong>Enable user-specified Ami ID</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code>.</p></li>
</ul>
<p>Note that we skip the network setting in this tutorial as it depends on your account. You may need to consult your account admins for this part.</p>
</div>
<div class="section" id="create-an-aws-batch-job-queue">
<h3>4. Create an AWS batch job queue<a class="headerlink" href="#create-an-aws-batch-job-queue" title="Permalink to this headline">¶</a></h3>
<p>After we have <code class="docutils literal notranslate"><span class="pre">lorien-c5-env</span></code> compute environment, we can then go to <code class="docutils literal notranslate"><span class="pre">Job</span> <span class="pre">queues</span></code> on the AWS batch console and click <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">queue</span></code> to create a job queue.</p>
<ul class="simple">
<li><p><strong>Queue name</strong>: <code class="docutils literal notranslate"><span class="pre">lorien-c5-queue</span></code>.</p></li>
<li><p><strong>Priority</strong>: <code class="docutils literal notranslate"><span class="pre">1</span></code> (I usually use the same priority number for all queues.)</p></li>
<li><p><strong>Connected compute environments for this queue</strong>: <code class="docutils literal notranslate"><span class="pre">lorien-c5-env</span></code> (you may need to wait for about a minute to see the compute environment we just created to appear in the drop down menu.)</p></li>
</ul>
</div>
<div class="section" id="create-an-aws-batch-job-definition">
<h3>5. Create an AWS batch job definition<a class="headerlink" href="#create-an-aws-batch-job-definition" title="Permalink to this headline">¶</a></h3>
<p>Now we can create a job definition. Go to <code class="docutils literal notranslate"><span class="pre">Job</span> <span class="pre">definitions</span></code> on the AWS batch console and click <code class="docutils literal notranslate"><span class="pre">Create</span></code>.</p>
<ul class="simple">
<li><p><strong>Job definition name</strong>: <code class="docutils literal notranslate"><span class="pre">lorien-job-cpu</span></code> (Job definition is independent to job queues, so we can use one job definition for all CPU environments).</p></li>
<li><p><strong>Job attempts</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code>.</p></li>
<li><p><strong>Execution timeout</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code>.</p></li>
<li><p><strong>Job role</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code>.</p></li>
<li><p><strong>Container image</strong>: <code class="docutils literal notranslate"><span class="pre">&lt;aws_account&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;ecr_repo&gt;/lorien:cpu-latest</span></code> (Assuming you pushed your images to AWS ECR.)</p></li>
<li><p><strong>Command</strong>: <code class="docutils literal notranslate"><span class="pre">N/A</span></code> (Lorien will override this field when submitting jobs.)</p></li>
<li><p><strong>vCPUs</strong>: <code class="docutils literal notranslate"><span class="pre">16</span></code> (We suggest to put the core number of an instance to let one job occupy one instance.)</p></li>
<li><p><strong>Memory (MiB)</strong>: <code class="docutils literal notranslate"><span class="pre">25000</span></code> (You may need to do some math or experiments for a proper memory capacity. Note that if the memory capacity you put here is larger than the total memory allocated to an instance, your job will stuck at <code class="docutils literal notranslate"><span class="pre">RUNNABLE</span></code> and never get started. We suggest to put at most 80% of instance memory capacity.)</p></li>
<li><p><strong>Number of GPUs</strong>: <code class="docutils literal notranslate"><span class="pre">0</span></code> (If you are working on GPU job definition, put <code class="docutils literal notranslate"><span class="pre">1</span></code> here).</p></li>
</ul>
</div>
<div class="section" id="configure-lorien-and-start-tuning">
<h3>6. Configure Lorien and start tuning<a class="headerlink" href="#configure-lorien-and-start-tuning" title="Permalink to this headline">¶</a></h3>
<p>Finally, we configure Lorien accordingly to make use of the AWS batch environment we just created. Note that if you have no idea about how to prepare the workloads for tuning, you can refer to <a class="reference internal" href="tune_on_local.html#tune-on-local"><span class="std std-ref">Tuning on Local</span></a>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># tune_batch.yaml</span>
<span class="nt">batch</span><span class="p">:</span>
  <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">llvm -mcpu=skylake-avx512</span>
  <span class="nt">job_queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lorien-c5-queue</span>
  <span class="nt">job_def</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lorien-job-cpu:1</span>
<span class="nt">tuner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">random</span>
<span class="nt">ntrial</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3000</span>
<span class="nt">commit-table-name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lorien</span>
<span class="nt">commit-nbest</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="nt">commit-log-to</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tuned-logs</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 -m lorien tune @tune_batch.yaml @workloads.yaml
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">lorien-job-cpu:1</span></code> means we are using Revision 1 of <code class="docutils literal notranslate"><span class="pre">lorien-job-cpu</span></code> job definition. You may need to specify a proper version if you refine the job definition multiple times.</p>
<p><code class="docutils literal notranslate"><span class="pre">commit-nbest</span></code> indicates how many best configs we will commit to the database, and <code class="docutils literal notranslate"><span class="pre">commit-log-to</span></code> specifies S3 bucket that we want to keep complete tuning logs. Note that tuning logs will not be stored if <code class="docutils literal notranslate"><span class="pre">commit-log-to</span></code> is unset.</p>
<p>During the tuning process, in addition to tracking the progress directly with the progress bar Lorien displays, you can also login your AWS batch console and see the dashboard for live job status. If jobs failed for some reasons, you can to go <code class="docutils literal notranslate"><span class="pre">Jobs</span></code>, click a job ID, and choose <code class="docutils literal notranslate"><span class="pre">View</span> <span class="pre">logs</span> <span class="pre">for</span> <span class="pre">this</span> <span class="pre">job</span> <span class="pre">in</span> <span class="pre">CloudWatch</span> <span class="pre">console</span></code> to see the logs.</p>
<p>Meanwhile, all state changes of tuing jobs will be recorded in a <code class="docutils literal notranslate"><span class="pre">lorien-tune-&lt;timestampe&gt;.trace</span></code> file. In case the master was interrupted and you wish to resume the tuning, you could specify <code class="docutils literal notranslate"><span class="pre">--trace-file</span></code> in the command, so that the tuning master will skip the finished jobs and keep tracking the state of tuning jobs.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 -m lorien tune @tune_batch.yaml @workloads.yaml --trace-file<span class="o">=</span>&lt;trace_file_path&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://fredhutch.github.io/aws-batch-at-hutch-docs">https://fredhutch.github.io/aws-batch-at-hutch-docs</a></p></li>
<li><p><a class="reference external" href="https://aws.amazon.com/blogs/compute/creating-a-simple-fetch-and-run-aws-batch-job/">https://aws.amazon.com/blogs/compute/creating-a-simple-fetch-and-run-aws-batch-job/</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="tune_on_rpc.html" class="btn btn-neutral float-right" title="Tuning on RPC Workers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="tune_on_local.html" class="btn btn-neutral float-left" title="Tuning on Local" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright .

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>